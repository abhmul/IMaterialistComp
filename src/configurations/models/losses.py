import tensorflow as tf
import keras.backend as K
import numpy as np


def f1_loss(y_true, y_pred):
    tp = K.mean(y_pred * y_true, axis=0)
    fp = K.mean(y_pred * (1. - y_true), axis=0)
    fn = K.mean((1. - y_pred) * y_true, axis=0)

    smoothing = 1e-9

    # Clip to keep f1 score in good range
    f1 = K.clip((2 * tp + smoothing) / (2 * tp + fp + fn + smoothing), 0., 1.)

    return 1. - K.mean(f1, axis=-1)


def f1_bce(y_true, y_pred):
    return (f1_loss(y_true, y_pred) +
            K.mean(K.binary_crossentropy(y_true, y_pred), axis=-1)) / 2.


def weighted_loss(y_true, y_pred):
    # avoiding overflow
    epsilon = 1e-7
    y_pred = K.clip(y_pred, epsilon, 1. - epsilon)
    logit_y_pred = K.log(y_pred / (1. - y_pred))

    # https://www.tensorflow.org/api_docs/python/tf/nn/weighted_cross_entropy_with_logits
    loss = (1. - y_true) * logit_y_pred + (1. + (POS_CLASS_WEIGHTS - 1.) * y_true) * \
                                          (K.log(1. + K.exp(-K.abs(logit_y_pred))) + K.maximum(-logit_y_pred, 0.))
    return K.sum(loss) / K.sum(POS_CLASS_WEIGHTS)

CLASS_WEIGHTS = np.array([[1.12256343e-04, 9.99887744e-01],
                          [2.15102676e-02, 9.78489732e-01],
                          [2.86009638e-03, 9.97139904e-01],
                          [5.17648161e-03, 9.94823518e-01],
                          [4.91194710e-03, 9.95088053e-01],
                          [4.66888772e-03, 9.95331112e-01],
                          [2.67892441e-02, 9.73210756e-01],
                          [2.21974716e-03, 9.97780253e-01],
                          [1.03432018e-02, 9.89656798e-01],
                          [2.86985781e-03, 9.97130142e-01],
                          [5.88613693e-03, 9.94113863e-01],
                          [1.21724921e-03, 9.98782751e-01],
                          [7.84818257e-03, 9.92151817e-01],
                          [1.27903901e-02, 9.87209610e-01],
                          [1.02153272e-02, 9.89784673e-01],
                          [2.63558370e-05, 9.99973644e-01],
                          [2.50396070e-01, 7.49603930e-01],
                          [3.85605418e-02, 9.61439458e-01],
                          [1.24903240e-01, 8.75096760e-01],
                          [1.04782999e-01, 8.95217001e-01],
                          [3.68200804e-03, 9.96317992e-01],
                          [1.20065480e-03, 9.98799345e-01],
                          [3.26031465e-04, 9.99673969e-01],
                          [3.36769028e-04, 9.99663231e-01],
                          [8.06683840e-03, 9.91933162e-01],
                          [9.14157087e-03, 9.90858429e-01],
                          [8.85360894e-04, 9.99114639e-01],
                          [1.56202261e-02, 9.84379774e-01],
                          [7.20392878e-04, 9.99279607e-01],
                          [5.01248974e-03, 9.94987510e-01],
                          [3.45749536e-03, 9.96542505e-01],
                          [1.24663109e-02, 9.87533689e-01],
                          [3.92311514e-03, 9.96076885e-01],
                          [3.05434866e-03, 9.96945651e-01],
                          [3.62929637e-03, 9.96370704e-01],
                          [6.13017246e-02, 9.38698275e-01],
                          [1.00025282e-02, 9.89997472e-01],
                          [9.15523686e-03, 9.90844763e-01],
                          [4.31161970e-03, 9.95688380e-01],
                          [6.60750595e-03, 9.93392494e-01],
                          [1.78634006e-04, 9.99821366e-01],
                          [4.80847604e-03, 9.95191524e-01],
                          [3.95532783e-03, 9.96044672e-01],
                          [7.42941760e-02, 9.25705824e-01],
                          [3.39697455e-03, 9.96603025e-01],
                          [6.93060899e-05, 9.99930694e-01],
                          [1.05159790e-02, 9.89484021e-01],
                          [8.38603687e-03, 9.91613963e-01],
                          [6.77745229e-02, 9.32225477e-01],
                          [8.99026884e-04, 9.99100973e-01],
                          [9.96445867e-03, 9.90035541e-01],
                          [8.64080996e-03, 9.91359190e-01],
                          [1.42049176e-01, 8.57950824e-01],
                          [2.66584410e-03, 9.97334156e-01],
                          [9.73116070e-03, 9.90268839e-01],
                          [8.06390998e-03, 9.91936090e-01],
                          [2.32809893e-03, 9.97671901e-01],
                          [3.02506440e-03, 9.96974936e-01],
                          [3.95835387e-02, 9.60416461e-01],
                          [3.63027251e-03, 9.96369727e-01],
                          [2.54831659e-02, 9.74516834e-01],
                          [1.24522544e-01, 8.75477456e-01],
                          [2.04394397e-02, 9.79560560e-01],
                          [5.50836993e-03, 9.94491630e-01],
                          [1.23150089e-02, 9.87684991e-01],
                          [7.32938256e-01, 2.67061744e-01],
                          [1.61356291e-03, 9.98386437e-01],
                          [3.31888318e-04, 9.99668112e-01],
                          [9.05664650e-03, 9.90943353e-01],
                          [4.77626335e-02, 9.52237367e-01],
                          [8.02193587e-03, 9.91978064e-01],
                          [8.87020336e-03, 9.91129797e-01],
                          [3.42108526e-02, 9.65789147e-01],
                          [1.13769363e-02, 9.88623064e-01],
                          [5.77973744e-03, 9.94220263e-01],
                          [2.37202533e-04, 9.99762797e-01],
                          [6.37323184e-03, 9.93626768e-01],
                          [4.50470061e-02, 9.54952994e-01],
                          [5.67333795e-02, 9.43266621e-01],
                          [2.45987812e-03, 9.97540122e-01],
                          [6.81835264e-03, 9.93181647e-01],
                          [8.83310996e-03, 9.91166890e-01],
                          [2.93818775e-04, 9.99706181e-01],
                          [5.66162424e-05, 9.99943384e-01],
                          [1.14013399e-03, 9.98859866e-01],
                          [6.83299477e-05, 9.99931670e-01],
                          [2.10426955e-02, 9.78957305e-01],
                          [2.17464939e-02, 9.78253506e-01],
                          [3.47897048e-03, 9.96521030e-01],
                          [1.09718373e-03, 9.98902816e-01],
                          [3.34963165e-02, 9.66503683e-01],
                          [8.73061504e-03, 9.91269385e-01],
                          [9.31141959e-03, 9.90688580e-01],
                          [3.60196439e-04, 9.99639804e-01],
                          [1.80029889e-02, 9.81997011e-01],
                          [3.09144206e-03, 9.96908558e-01],
                          [3.01969562e-02, 9.69803044e-01],
                          [8.76858697e-02, 9.12314130e-01],
                          [1.63093824e-02, 9.83690618e-01],
                          [2.05106980e-02, 9.79489302e-01],
                          [1.13232485e-02, 9.88676752e-01],
                          [5.77290444e-03, 9.94227096e-01],
                          [8.43191555e-03, 9.91568084e-01],
                          [1.84490859e-04, 9.99815509e-01],
                          [3.26263787e-01, 6.73736213e-01],
                          [1.90500966e-01, 8.09499034e-01],
                          [6.63776635e-05, 9.99933622e-01],
                          [4.75381208e-04, 9.99524619e-01],
                          [7.94189221e-03, 9.92058108e-01],
                          [2.85053019e-02, 9.71494698e-01],
                          [6.70316787e-03, 9.93296832e-01],
                          [1.11084972e-03, 9.98889150e-01],
                          [7.65012334e-02, 9.23498767e-01],
                          [9.75458811e-03, 9.90245412e-01],
                          [2.37026827e-02, 9.76297317e-01],
                          [5.65508409e-02, 9.43449159e-01],
                          [1.44664261e-02, 9.85533574e-01],
                          [3.86064205e-03, 9.96139358e-01],
                          [7.84818257e-04, 9.99215182e-01],
                          [4.23255219e-03, 9.95767448e-01],
                          [6.14871916e-03, 9.93851281e-01],
                          [3.05142024e-02, 9.69485798e-01],
                          [5.69090851e-04, 9.99430909e-01],
                          [4.06075118e-04, 9.99593925e-01],
                          [9.96641095e-04, 9.99003359e-01],
                          [4.35652224e-03, 9.95643478e-01],
                          [3.70641159e-03, 9.96293588e-01],
                          [2.99861095e-02, 9.70013891e-01],
                          [9.18549726e-04, 9.99081450e-01],
                          [3.72007758e-03, 9.96279922e-01],
                          [5.04811893e-02, 9.49518811e-01],
                          [7.81206531e-03, 9.92187935e-01],
                          [6.00981413e-02, 9.39901859e-01],
                          [9.21478152e-04, 9.99078522e-01],
                          [1.11124018e-02, 9.88887598e-01],
                          [9.21087696e-03, 9.90789123e-01],
                          [1.03687767e-01, 8.96312233e-01],
                          [1.01453378e-01, 8.98546622e-01],
                          [6.79394909e-03, 9.93206051e-01],
                          [7.53484095e-03, 9.92465159e-01],
                          [5.75826231e-03, 9.94241738e-01],
                          [2.62718888e-02, 9.73728111e-01],
                          [1.70873676e-02, 9.82912632e-01],
                          [2.11461665e-02, 9.78853833e-01],
                          [4.19741108e-05, 9.99958026e-01],
                          [2.39545274e-03, 9.97604547e-01],
                          [7.21076177e-03, 9.92789238e-01],
                          [1.00169751e-01, 8.99830249e-01],
                          [1.18503652e-03, 9.98814963e-01],
                          [7.85501556e-03, 9.92144984e-01],
                          [3.06713613e-02, 9.69328639e-01],
                          [4.02268164e-03, 9.95977318e-01],
                          [2.58295012e-01, 7.41704988e-01],
                          [3.21580257e-02, 9.67841974e-01],
                          [1.98313031e-02, 9.80168697e-01],
                          [7.41868004e-05, 9.99925813e-01],
                          [2.53796949e-04, 9.99746203e-01],
                          [1.21959195e-02, 9.87804080e-01],
                          [1.47309606e-02, 9.85269039e-01],
                          [1.86833600e-03, 9.98131664e-01],
                          [9.56619268e-05, 9.99904338e-01],
                          [5.07593898e-05, 9.99949241e-01],
                          [7.80913689e-06, 9.99992191e-01],
                          [1.15206244e-01, 8.84793756e-01],
                          [1.33009124e-02, 9.86699088e-01],
                          [2.10827173e-02, 9.78917283e-01],
                          [1.27679388e-02, 9.87232061e-01],
                          [4.40435320e-03, 9.95595647e-01],
                          [8.43777240e-03, 9.91562228e-01],
                          [3.54378632e-02, 9.64562137e-01],
                          [2.39674125e-01, 7.60325875e-01],
                          [2.38178675e-04, 9.99761821e-01],
                          [6.12041103e-04, 9.99387959e-01],
                          [2.85033496e-04, 9.99714967e-01],
                          [4.85894258e-02, 9.51410574e-01],
                          [6.57138869e-02, 9.34286113e-01],
                          [1.59892078e-03, 9.98401079e-01],
                          [7.23516532e-03, 9.92764835e-01],
                          [2.63558370e-04, 9.99736442e-01],
                          [3.62861307e-02, 9.63713869e-01],
                          [1.88785884e-02, 9.81121412e-01],
                          [2.07430199e-03, 9.97925698e-01],
                          [1.52834570e-02, 9.84716543e-01],
                          [6.34668078e-02, 9.36533192e-01],
                          [4.70207655e-03, 9.95297923e-01],
                          [5.89833870e-02, 9.41016613e-01],
                          [5.92127804e-03, 9.94078722e-01],
                          [3.15001059e-03, 9.96849989e-01],
                          [2.16420467e-02, 9.78357953e-01],
                          [3.52846089e-02, 9.64715391e-01],
                          [5.90565977e-04, 9.99409434e-01],
                          [1.08058932e-03, 9.98919411e-01],
                          [2.73505258e-02, 9.72649474e-01],
                          [6.36444656e-04, 9.99363555e-01],
                          [1.04935277e-03, 9.98950647e-01],
                          [3.17929485e-03, 9.96820705e-01],
                          [1.09913602e-03, 9.98900864e-01],
                          [6.13017246e-04, 9.99386983e-01],
                          [1.37245581e-03, 9.98627544e-01],
                          [6.91206229e-03, 9.93087938e-01],
                          [7.24785517e-03, 9.92752145e-01],
                          [1.52668626e-03, 9.98473314e-01],
                          [1.42048200e-02, 9.85795180e-01],
                          [2.44875010e-02, 9.75512499e-01],
                          [3.22068328e-02, 9.67793167e-01],
                          [2.84838268e-03, 9.97151617e-01],
                          [2.38178675e-04, 9.99761821e-01],
                          [8.42410642e-04, 9.99157589e-01],
                          [2.26562584e-03, 9.97734374e-01],
                          [1.43326946e-02, 9.85667305e-01],
                          [1.10792130e-03, 9.98892079e-01],
                          [6.95403640e-03, 9.93045964e-01],
                          [5.22236029e-03, 9.94777640e-01],
                          [1.48465358e-01, 8.51534642e-01],
                          [1.04447206e-04, 9.99895553e-01],
                          [7.23418918e-03, 9.92765811e-01],
                          [8.92974803e-03, 9.91070252e-01],
                          [3.19139902e-02, 9.68086010e-01],
                          [5.81780698e-04, 9.99418219e-01],
                          [1.44693545e-02, 9.85530645e-01],
                          [2.83081212e-04, 9.99716919e-01],
                          [1.51034564e-01, 8.48965436e-01],
                          [2.10846696e-04, 9.99789153e-01],
                          [1.43541697e-02, 9.85645830e-01],
                          [8.99807798e-03, 9.91001922e-01],
                          [2.72431502e-02, 9.72756850e-01],
                          [7.36108766e-03, 9.92638912e-01],
                          [1.76096037e-03, 9.98239040e-01]])
POS_CLASS_WEIGHTS = K.variable(1. / CLASS_WEIGHTS[None, :, 0] * CLASS_WEIGHTS[None, :, 1])
